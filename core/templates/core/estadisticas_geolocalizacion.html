<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mapa de Calor - Estad√≠sticas</title>
    <style>
        #map {
            height: 90vh;
            width: 100%;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=visualization"></script>
</head>
<body>

    <h2 style="text-align:center;">üìç Mapa de calor de denuncias</h2>

    <div style="text-align:center; margin-bottom:10px;">
        <label for="comunaSelect"><strong>Filtrar por comuna:</strong></label>
        <select id="comunaSelect">
            <option value="">-- Ver todas --</option>
            {% for comuna in comunas %}
                <option value="{{ comuna.nombre }}" {% if comuna.nombre == comuna_activa %}selected{% endif %}>
                    {{ comuna.nombre }}
                </option>
            {% endfor %}
        </select>
    </div>

    <div id="map"></div>

    <script>
        let map;
        let heatmap;
        let poligonoComuna;

        function cargarHeatmap(comuna = "") {
            if (heatmap) {
                heatmap.setMap(null); // Quitar heatmap anterior
            }

            const url = comuna
                ? "{% url 'api_eventos_por_comuna' %}?comuna=" + encodeURIComponent(comuna)
                : "{% url 'api_eventos_geolocalizados' %}";

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const heatmapData = data.map(p => new google.maps.LatLng(p.lat, p.lng));
                    heatmap = new google.maps.visualization.HeatmapLayer({
                        data: heatmapData,
                        radius: 25
                    });
                    heatmap.setMap(map);
                });
        }

        function cargarPoligono(nombre_comuna) {
            if (poligonoComuna) {
                poligonoComuna.setMap(null);  // quitar el anterior
            }

            if (!nombre_comuna) return; // no cargar si est√° vac√≠o (ver todas)

            fetch("{% url 'geojson_comuna_nombre' %}?comuna=" + encodeURIComponent(nombre_comuna))
                .then(res => res.json())
                .then(data => {
                    if (data.features.length === 0) return;

                    const coords = data.features[0].geometry.coordinates[0].map(c => ({
                        lat: c[1],
                        lng: c[0]
                    }));

                    poligonoComuna = new google.maps.Polygon({
                        paths: coords,
                        strokeColor: "#FF0000",
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: "#FF0000",
                        fillOpacity: 0.1
                    });

                    poligonoComuna.setMap(map);

                    const bounds = new google.maps.LatLngBounds();
                    coords.forEach(c => bounds.extend(c));
                    map.fitBounds(bounds);
                });
        }

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -33.45, lng: -70.66 },
                zoom: 12,
                mapTypeId: "roadmap"
            });

            const comunaInicial = document.getElementById("comunaSelect").value;

            if (comunaInicial) {
                cargarPoligono(comunaInicial);
                cargarHeatmap(comunaInicial);
            } else {
                cargarHeatmap();
            }

            document.getElementById("comunaSelect").addEventListener("change", function () {
                const seleccionada = this.value;
                cargarPoligono(seleccionada);
                cargarHeatmap(seleccionada);
            });
        }

        window.onload = initMap;
    </script>

</body>
</html>
