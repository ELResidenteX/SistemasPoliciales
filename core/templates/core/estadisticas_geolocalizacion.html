<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>游늸 Dashboard de Estad칤sticas - Carabineros de Chile</title>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            color: #333;
        }

        header {
            background-color: #1b5e20;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        h2, h3 {
            text-align: center;
            color: #2e7d32;
        }

        #map {
            height: 60vh;
            width: 100%;
        }

        .filtros-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            background-color: #e8f5e9;
            padding: 15px 10px;
            margin-bottom: 10px;
            border-bottom: 2px solid #2e7d32;
        }

        .filtros-container label {
            margin: 5px 10px;
            font-weight: 600;
            color: #1b5e20;
        }

        .filtros-container select,
        .filtros-container input[type="date"],
        .filtros-container button {
            margin: 5px 5px;
            padding: 6px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .filtros-container button {
            background-color: #2e7d32;
            color: #fff;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .filtros-container button:hover {
            background-color: #1b5e20;
        }

        .kpi-container {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            margin: 20px auto;
            max-width: 1100px;
            gap: 15px;
        }

        .kpi-card {
            flex: 1;
            background-color: #e8f5e9;
            border-left: 5px solid #2e7d32;
            padding: 15px 20px;
            text-align: center;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            min-width: 200px;
        }

        .kpi-card h4 {
            color: #1b5e20;
            margin: 0;
            font-size: 16px;
        }

        .kpi-card p {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0 0;
            color: #1b5e20;
        }

        .charts {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin: 20px auto;
            max-width: 1200px;
            gap: 30px;
        }

        .chart-container {
            flex: 1;
            min-width: 380px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 6px rgba(0,0,0,0.1);
        }

        .tabla-container {
            max-width: 1000px;
            margin: 40px auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 6px rgba(0,0,0,0.1);
        }

        th {
            background-color: #1b5e20;
            color: white;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            border-bottom: 1px solid #ccc;
            text-align: left;
        }

        tr:hover {
            background-color: #f1f8e9;
        }

        .export-buttons {
            text-align: center;
            margin: 15px 0;
        }

        .export-buttons button {
            background-color: #388e3c;
            color: white;
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .export-buttons button:hover {
            background-color: #1b5e20;
        }
    </style>

    <!-- Librer칤as -->
    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=visualization"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>

<header>
    <h2>游늸 Dashboard de Estad칤sticas - Carabineros de Chile</h2>
</header>

<!-- KPIs -->
<div class="kpi-container">
    <div class="kpi-card"><h4>Total de denuncias</h4><p id="kpi-total">0</p></div>
    <div class="kpi-card"><h4>Tipos de delitos</h4><p id="kpi-delitos">0</p></div>
    <div class="kpi-card"><h4>Comuna seleccionada</h4><p id="kpi-comuna">Todas</p></div>
    <div class="kpi-card"><h4>Rango de fechas</h4><p id="kpi-fechas">-</p></div>
</div>

<!-- Filtros -->
<div class="filtros-container">
    <label>Comuna:</label>
    <select id="comunaSelect">
        <option value="">-- Ver todas --</option>
        {% for comuna in comunas %}
        <option value="{{ comuna.nombre }}" {% if comuna.nombre == comuna_activa %}selected{% endif %}>{{ comuna.nombre }}</option>
        {% endfor %}
    </select>

    <label>Delito:</label>
    <select id="delitoSelect">
        <option value="">-- Todos --</option>
        {% for delito in delitos %}
        <option value="{{ delito.id }}">{{ delito.nombre }}</option>
        {% endfor %}
    </select>

    <label>Desde:</label><input type="date" id="fechaDesde">
    <label>Hasta:</label><input type="date" id="fechaHasta">

    <button onclick="aplicarFiltros()">Aplicar filtros</button>
</div>

<!-- Mapa -->
<div id="map"></div>

<!-- Gr치ficos -->
<div class="charts">
    <div class="chart-container">
        <h3>游늵 Delitos por tipo</h3>
        <canvas id="graficoDelitos"></canvas>
    </div>
    <div class="chart-container">
        <h3>游늳 Distribuci칩n porcentual</h3>
        <canvas id="graficoTorta"></canvas>
    </div>
    <div class="chart-container">
        <h3>游늰 Evoluci칩n temporal</h3>
        <canvas id="graficoLinea"></canvas>
    </div>
    <div class="chart-container">
        <h3>游끥 Top 5 unidades policiales</h3>
        <canvas id="graficoTopUnidades"></canvas>
    </div>
    <div class="chart-container">
        <h3>游늸 Ranking comunas m치s conflictivas</h3>
        <canvas id="graficoComunas"></canvas>
    </div>
    <div class="chart-container">
        <h3>丘멆잺 Porcentaje delitos cr칤ticos</h3>
        <canvas id="graficoCriticos"></canvas>
    </div>
</div>

<!-- Tabla -->
<div class="tabla-container">
    <h3>游늶 Resumen por unidad policial</h3>
    <table id="tablaUnidades">
        <thead><tr><th>Unidad Policial</th><th>Comuna</th><th>Total Denuncias</th></tr></thead>
        <tbody><tr><td colspan="3" style="text-align:center;">Sin datos disponibles</td></tr></tbody>
    </table>

    <div class="export-buttons">
        <button onclick="exportarPDF()">游늯 Exportar PDF</button>
        <button onclick="exportarExcel()">游늵 Exportar Excel</button>
    </div>
</div>

<script>
let map, heatmap;
let chartLinea, chartUnidades, chartComunas, chartCriticos;

// === Funci칩n para consumir APIs ===
async function fetchData(url) {
    const res = await fetch(url);
    return await res.json();
}

// === GRAFICO EVOLUCI칍N TEMPORAL ===
async function cargarGraficoLinea() {
    const ctx = document.getElementById("graficoLinea").getContext("2d");
    if (chartLinea) chartLinea.destroy();
    const data = await fetchData("{% url 'api_eventos_tiempo' %}");
    chartLinea = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.fechas,
            datasets: [{
                label: "Delitos por d칤a",
                data: data.valores,
                borderColor: "#2e7d32",
                backgroundColor: "rgba(46,125,50,0.2)",
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// === GRAFICO TOP UNIDADES ===
async function cargarTopUnidades() {
    const ctx = document.getElementById("graficoTopUnidades").getContext("2d");
    if (chartUnidades) chartUnidades.destroy();
    const data = await fetchData("{% url 'api_top_unidades' %}");
    const labels = data.map(d => d.nombre_unidad);
    const valores = data.map(d => d.total);
    chartUnidades = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Delitos",
                data: valores,
                backgroundColor: "#81c784"
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: { x: { beginAtZero: true } }
        }
    });
}

// === GRAFICO TOP COMUNAS ===
async function cargarComunas() {
    const ctx = document.getElementById("graficoComunas").getContext("2d");
    if (chartComunas) chartComunas.destroy();
    const data = await fetchData("{% url 'api_top_comunas' %}");
    const labels = data.map(c => c.nombre_comuna);
    const valores = data.map(c => c.total);
    chartComunas = new Chart(ctx, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Cantidad de Delitos",
                data: valores,
                backgroundColor: "#a5d6a7",
                borderColor: "#2e7d32",
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// === GRAFICO PORCENTAJE DELITOS CR칈TICOS ===
async function cargarCriticos() {
    const ctx = document.getElementById("graficoCriticos").getContext("2d");
    if (chartCriticos) chartCriticos.destroy();
    const data = await fetchData("{% url 'api_porcentaje_delitos_criticos' %}");
    chartCriticos = new Chart(ctx, {
        type: "doughnut",
        data: {
            labels: ["Cr칤ticos", "No cr칤ticos"],
            datasets: [{
                data: [data.porcentaje, 100 - data.porcentaje],
                backgroundColor: ["#d32f2f", "#81c784"]
            }]
        },
        options: {
            plugins: { legend: { position: "bottom" } }
        }
    });
}

// === EXPORTAR PDF ===
function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();
    pdf.text("Reporte de Estad칤sticas", 10, 10);
    pdf.text("Generado: " + new Date().toLocaleString(), 10, 20);
    pdf.save("reporte_estadisticas.pdf");
}

// === EXPORTAR EXCEL ===
function exportarExcel() {
    const tabla = document.getElementById("tablaUnidades");
    const wb = XLSX.utils.table_to_book(tabla, { sheet: "Resumen" });
    XLSX.writeFile(wb, "reporte_estadisticas.xlsx");
}

// === INICIALIZACI칍N DEL MAPA Y DASHBOARD ===
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -33.45, lng: -70.66 },
        zoom: 12
    });

    cargarHeatmap();
    cargarGraficoDelitos();
    cargarGraficoLinea();
    cargarTopUnidades();
    cargarComunas();
    cargarCriticos();
}

window.onload = initMap;
</script>

</body>
</html>





