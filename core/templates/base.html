<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>{% block title %}Sistema Policial / GeoDepol{% endblock %}</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Fuente moderna -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Estilos propios (original) -->
    <link rel="stylesheet" href="{% static 'core/styles.css' %}">

    <style>
        body {
            background: #0d1117;
            font-family: "Inter", sans-serif;
            color: #e5e7eb;
            overflow-x: hidden;
        }

        a { text-decoration: none; color: inherit; }

        /* Contenedor principal cuando usamos dashboard */
        .container-dashboard {
            max-width: 1500px;
            margin: auto;
            padding: 40px 30px;
        }

        .tag {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(255,255,255,0.12);
            color: #d1d5db;
            border-radius: 6px;
            font-size: 0.75rem;
            margin-bottom: 10px;
        }

        .hero-card {
            background: rgba(255,255,255,0.03);
            backdrop-filter: blur(12px);
            border-radius: 22px;
            padding: 45px 50px;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 0 50px rgba(0,0,0,0.45);
            margin-bottom: 40px;
        }

        .hero-title { font-size: 2.2rem; font-weight: 600; margin-bottom: 12px; }
        .hero-sub { font-size: 1rem; color: #9ca3af; margin-bottom: 25px; max-width: 650px; }

        .btn-blue {
            background: #3b82f6; color: white; border: none;
            padding: 10px 26px; border-radius: 7px; font-weight: 500;
        }

        /* TARJETAS DASHBOARD */
        .module-card {
            background: rgba(255,255,255,0.04);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 20px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
            margin-bottom: 25px;
        }

        .module-card:hover {
            background: rgba(255,255,255,0.07);
            transform: translateY(-3px);
        }

        .module-content {
            display: none;
            margin-top: 20px;
            text-align: left;
        }

        .module-card.open .module-content { display: block; }

        .module-option {
            display: block;
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            transition: background 0.2s ease, transform 0.15s ease;
        }

        .module-option:hover {
            background: rgba(255,255,255,0.10);
            transform: translateX(3px);
        }

        .option-title { font-size: 0.97rem; font-weight: 500; }
        .option-desc { font-size: 0.82rem; color: #9ca3af; }

        /* Sidebar original */
        .sidebar {
            min-width: 260px;
            max-width: 260px;
            background-color: #198754;
            color: white;
            padding: 20px;
        }

        .main {
            background: #0d1117;
            min-height: 100vh;
        }

    </style>
</head>
<body>

<div class="d-flex">

    <!-- ========== SIDEBAR ORIGINAL ========== -->
    <div class="sidebar">
        <h3>MENÚ</h3>

        <div class="accordion" id="menuAcordeon">

            <!-- EVENTOS POLICIALES -->
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-success text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#eventos">
                        EVENTOS POLICIALES
                    </button>
                </h2>
                <div id="eventos" class="accordion-collapse collapse" data-bs-parent="#menuAcordeon">
                    <div class="accordion-body p-2">
                        <ul class="list-unstyled">
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'nuevo_evento' %}', 'Nuevo Evento Policial')">
                                    Nuevo
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'buscar_evento' %}', 'Buscar Evento')">
                                    Buscar Evento
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'evento_en_validacion' %}', 'Eventos en Validación')">
                                    Eventos en Validación
                                </a>
                            </li>
                            <li><a href="#" class="text-white d-block py-1">Repositorio de partes</a></li>
                            <li><a href="#" class="text-white d-block py-1">Actas del Detenido</a></li>
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'vista_busqueda_partes' %}', 'Búsqueda de partes')">
                                    Búsqueda de partes
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- INFRACCIÓN AL TRÁNSITO -->
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-success text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#transito">
                        INFRACCIÓN AL TRÁNSITO
                    </button>
                </h2>
                <div id="transito" class="accordion-collapse collapse" data-bs-parent="#menuAcordeon">
                    <div class="accordion-body p-2">
                        <ul class="list-unstyled">
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'nueva_infraccion' %}', 'Nueva Infracción')">
                                    Nueva Infracción
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'vista_busqueda_partes_infracciones' %}', 'Búsqueda de parte')">
                                    Búsqueda de parte
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- CONSTANCIAS -->
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-success text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#constancias">
                        CONSTANCIAS
                    </button>
                </h2>
                <div id="constancias" class="accordion-collapse collapse" data-bs-parent="#menuAcordeon">
                    <div class="accordion-body p-2">
                        <ul class="list-unstyled">
                            <li><a href="#" class="text-white d-block py-1">Nueva</a></li>
                            <li><a href="#" class="text-white d-block py-1">Buscar constancia</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- OTRAS INFRACCIONES -->
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-success text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#otras">
                        OTRAS INFRACCIONES
                    </button>
                </h2>
                <div id="otras" class="accordion-collapse collapse" data-bs-parent="#menuAcordeon">
                    <div class="accordion-body p-2">
                        <ul class="list-unstyled">
                            <li><a href="#" class="text-white d-block py-1">Control vehicular</a></li>
                            <li><a href="#" class="text-white d-block py-1">Control entidades financieras</a></li>
                            <li><a href="#" class="text-white d-block py-1">Fiscalización de alcoholes</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ESTADÍSTICAS -->
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-success text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#estadisticas">
                        ESTADÍSTICAS
                    </button>
                </h2>
                <div id="estadisticas" class="accordion-collapse collapse" data-bs-parent="#menuAcordeon">
                    <div class="accordion-body p-2">
                        <ul class="list-unstyled">
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'estadisticas_geolocalizacion' %}', 'Mapa de geolocalización')">
                                    Mapa de geolocalización
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- OTROS -->
            <div class="accordion-item bg-transparent border-0">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed bg-success text-white" type="button"
                            data-bs-toggle="collapse" data-bs-target="#otros">
                        OTROS
                    </button>
                </h2>
                <div id="otros" class="accordion-collapse collapse" data-bs-parent="#menuAcordeon">
                    <div class="accordion-body p-2">
                        <ul class="list-unstyled">
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'cambio_clave' %}', 'Cambio de clave')">
                                    Cambio de clave
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" class="text-white d-block py-1"
                                   onclick="abrirFormularioAjax('{% url 'manuales_usuario' %}', 'Manuales')">
                                    Manuales
                                </a>
                            </li>

                            {% if request.user.perfilusuario.rol == "super_admin" or request.user.perfilusuario.rol == "administrador" %}
                                <li>
                                    <a href="javascript:void(0);" class="text-white d-block py-1"
                                       onclick="abrirFormularioAjax('{% url 'crear_usuario' %}', 'Configuración de usuarios')">
                                        Configuración de usuarios
                                    </a>
                                </li>
                            {% endif %}

                            <li><a href="{% url 'logout' %}" class="text-white d-block py-1">Salir</a></li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ========== PANEL PRINCIPAL ========== -->
    <div class="main flex-grow-1 p-4">

        {% if request.user.is_authenticated and request.user.perfilusuario %}
        <div class="alert alert-success mb-4 rounded-3 shadow-sm" role="alert" style="font-size: 0.95rem;">
            <strong>Usuario:</strong> {{ nombre_usuario }} &nbsp; | &nbsp;
            <strong>Rol:</strong> {{ rol_usuario }} &nbsp; | &nbsp;
            <strong>Unidad:</strong>
            {% if unidad_usuario %}
                {{ unidad_usuario }}
            {% else %}
                <span class="text-muted fst-italic">Sin unidad asignada</span>
            {% endif %}
        </div>
        {% endif %}

        <!-- HERO + DASHBOARD CENTRAL -->
        <div class="container-dashboard">

            <div class="hero-card">
                <div class="tag">GeoDepol · Centro Operativo</div>

                <h1 class="hero-title">Gestión integral de eventos y partes en tiempo real</h1>
                <p class="hero-sub">
                    Coordina eventos policiales, valida reportes, gestiona partes e información operativa con trazabilidad completa.
                </p>

                <button type="button" class="btn-blue"
                        onclick="abrirFormularioAjax('{% url 'nuevo_evento' %}', 'Nuevo Evento Policial')">
                    Crear evento policial
                </button>
            </div>

            <!-- Tarjetas opcionales tipo dashboard (puedes dejarlas o no) -->
            <div class="row">
                <div class="col-md-4">
                    <div class="module-card" onclick="toggleModule(this)">
                        <div class="module-title">Eventos Policiales</div>
                        <div class="module-subtitle">Registro, consulta y validación</div>
                        <div class="module-content">
                            <div class="module-option"
                                 onclick="abrirFormularioAjax('{% url 'nuevo_evento' %}', 'Nuevo Evento Policial'); event.stopPropagation();">
                                <div class="option-title">Nuevo evento policial</div>
                                <div class="option-desc">Crear registro de incidente.</div>
                            </div>
                            <div class="module-option"
                                 onclick="abrirFormularioAjax('{% url 'buscar_evento' %}', 'Buscar Evento'); event.stopPropagation();">
                                <div class="option-title">Buscar evento</div>
                                <div class="option-desc">Consultar por número o zona.</div>
                            </div>
                            <div class="module-option"
                                 onclick="abrirFormularioAjax('{% url 'evento_en_validacion' %}', 'Eventos en validación'); event.stopPropagation();">
                                <div class="option-title">Eventos en validación</div>
                                <div class="option-desc">Revisar pendientes.</div>
                            </div>
                            <div class="module-option"
                                 onclick="abrirFormularioAjax('{% url 'vista_busqueda_partes' %}', 'Búsqueda de partes'); event.stopPropagation();">
                                <div class="option-title">Búsqueda de partes</div>
                                <div class="option-desc">Partes enviados a Fiscalía.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Puedes replicar el resto de módulos aquí como en el sidebar si quieres doble acceso -->

            </div>

        </div>

        <!-- Bloque de contenido extendible (para vistas que extiendan base directamente) -->
        {% block content %}
        {% include "core/presentacion.html" %}
        {% endblock %}

    </div> <!-- /.main -->

</div> <!-- /.d-flex -->

<!-- ========== MODAL UNIVERSAL AJAX ========== -->
<div class="modal fade" id="modalGeodepolAjax" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content bg-dark text-light">

      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="modalGeodepolAjaxTitle">GeoDepol</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body" id="modalGeodepolAjaxBody">
        <!-- Aquí se carga el HTML por AJAX -->
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Google Maps principal (para que esté disponible globalmente) -->
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places"></script>

<script>
/* ==========================
   ACORDEÓN TARJETAS DASHBOARD
========================== */
function toggleModule(card) {
    if (card.classList.contains("open")) {
        card.classList.remove("open");
        card.querySelector(".module-content").style.display = "none";
        return;
    }

    document.querySelectorAll(".module-card.open").forEach(c => {
        c.classList.remove("open");
        c.querySelector(".module-content").style.display = "none";
    });

    card.classList.add("open");
    card.querySelector(".module-content").style.display = "block";
}

/* ==========================
   ABRIR FORMULARIO POR AJAX
========================== */
function abrirFormularioAjax(url, titulo) {
    const modalEl = document.getElementById('modalGeodepolAjax');
    const body = document.getElementById("modalGeodepolAjaxBody");
    const title = document.getElementById("modalGeodepolAjaxTitle");

    title.innerText = titulo;

    body.innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
        </div>
    `;

    const modal = new bootstrap.Modal(modalEl);
    modal.show();

    fetch(url, {
        headers: {
            "X-Requested-With": "XMLHttpRequest"
        }
    })
        .then(r => r.text())
        .then(html => {
            body.innerHTML = html;

            // Re-inyecta y ejecuta <script> que venga en el HTML (evento.js, general.js, etc.)
            const scripts = body.querySelectorAll("script");
            scripts.forEach(oldScript => {
                const s = document.createElement("script");
                if (oldScript.src) {
                    s.src = oldScript.src;
                } else {
                    s.textContent = oldScript.textContent;
                }
                document.body.appendChild(s);
            });

            // Si tu template define esta función (nuevo_evento.html), la forzamos
            if (typeof initAutocompleteAndMap === "function") {
                try { initAutocompleteAndMap(); } catch (e) { console.error(e); }
            }

            // Si en tus JS tienes alguna función de init para selects/regiones:
            if (typeof initFormularioEvento === "function") {
                try { initFormularioEvento(); } catch (e) { console.error(e); }
            }
            if (typeof initRegiones === "function") {
                try { initRegiones(); } catch (e) { console.error(e); }
            }
        })
        .catch(err => {
            console.error(err);
            body.innerHTML = `
                <div class="alert alert-danger m-3">
                    Error al cargar el contenido.
                </div>
            `;
        });
}

</script>

{% block script %}{% endblock %}

</body>
</html>
